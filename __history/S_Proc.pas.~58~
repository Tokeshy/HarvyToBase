unit S_Proc;

interface
  Procedure Delay(mSec:Cardinal);  // +
  Procedure RestoreDefSize;      // +
  Procedure ExpDefSize;         // +
  Procedure SetProxyParams;      // +
  Procedure LetSParse; //(IsItTest : boolean); возьму с формы напрямую
//  Procedure MailNotify;  // +
  Procedure BLSorter (BadLink : string);


implementation
uses
  Winapi.Windows, Vcl.Forms, System.SysUtils, Vcl.Dialogs,
  Main, S_Func, Py_code;


Procedure Delay(mSec:Cardinal);
{Sleep Alternative
difference is not make APP Freeze}
Var
  TargetTime : Cardinal;
Begin
  TargetTime := GetTickCount + mSec;
  While TargetTime > GetTickCount Do
    begin
      Application.ProcessMessages;
      Sleep(1);
      If Application.Terminated then Exit;
    end;
End;


Procedure RestoreDefSize;
{Just restoring default size of window}
begin
  Harvy.ClientWidth := 520;
  Harvy.ClientHeight := 138;
  Harvy.Btn_Options.Caption := '>>>'
end;


Procedure ExpDefSize;
{Big size of window for advance mode}
begin
    Harvy.ClientWidth := 784;
    Harvy.ClientHeight := 199;
    Harvy.Btn_Options.Caption := '<<<'
end;


Procedure SetProxyParams;
{Setting Proxy Params if needed}
begin
  if Harvy.Chck_UseProxy.Checked = True then
    with Harvy.IdHTTP_Main.ProxyParams do
      begin
        ProxyServer := Harvy.Edt_ProxyServerIP.Text;
        ProxyPort := strtoint(Harvy.Edt_ProxyPortNo.Text);
        ProxyUsername := Harvy.Edt_ProxyUsername.Text;
        ProxyPassword := Harvy.Edt_ProxyPassword.Text;
      end;
end;


Procedure LetSParse; // (IsItTest : boolean);
{Here we parse links}
var
  i : integer;
  PageHolder : string;
  PyCommand : string;
begin
  SetProxyParams;
  for i := strtoint(Harvy.Edt_ScanFrom.text) to strtoint(Harvy.Edt_ScanTo.text) do  // Page iterator for ours range
  begin

    {PageHolder := Harvy.IdHTTP_Main.Get(IceLink + inttostr(i));  }
    Harvy.Mem_PyOut.Clear;
    PyCommand := GetTheLink(IceLink + inttostr(i));

   // Harvy.Py_Engine. .NewInstance;

    Harvy.Py_Engine.LoadDll;
    //Harvy.Py_Engine.ExecString(PyCommand);
    Harvy.Py_Engine.Run_CommandAsString(PyCommand); // .ExecString(PyCommand);
    //Harvy.Py_Engine.Quit  ;//.Free;

    PageHolder := Harvy.Mem_PyOut.Lines.Text;
    showmessage(inttostr(length(PageHolder)));
    //showmessage(inttostr())
    //  16600


   { if Length(PageHolder) > 18000 then
      //ScanPage(PageHolder)  // Try to scan pages
      showmessage(inttostr(Length(PageHolder)))
    else
      BLSorter(inttostr(i)); // othercase means empty page so send it to BadLinks
    Delay (2000); } // just trying to fake an IP block))
  end;
end;


Procedure BLSorter(BadLink : string);
{Just sorting Bad links dependenly from App mode (Test\Normal)}
begin
  if Harvy.ChB_TestMode.Checked = True Then
    showmessage(BadLink + ' is BadLink');
  // написать для else запись в БД

end;

end.
